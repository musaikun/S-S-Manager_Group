<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤務時間設定</title>
    <link rel="stylesheet" th:href="@{/css/timeregister_css/timeregister.css}">
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="title">勤務時間の設定</h1>
            <p class="subtitle">各日の勤務時間を設定してください</p>
            
            <!-- 進捗インジケーター -->
            <div class="progress-indicator">
                <div class="progress-step completed">
                    <div class="step-circle">✓</div>
                    <div class="step-label">日付選択</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">時間設定</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <div class="step-circle">3</div>
                    <div class="step-label">確認・提出</div>
                </div>
            </div>
            
            <!-- 一括設定セクション - アコーディオン -->
            <div class="accordion">
                <button class="accordion-header" id="bulkAccordionBtn">
                    <span>一括設定</span>
                    <span class="accordion-icon">▼</span>
                </button>
                <div class="accordion-content" id="bulkAccordionContent">
                    <!-- 開始・終了時間表示 -->
                    <div class="bulk-time-compact">
                        <div class="bulk-time-item">
                            <span class="bulk-time-label">開始</span>
                            <button id="bulkStartTimeBtn" class="time-display-btn">
                                <span id="bulkStartTimeDisplay">09:00</span>
                            </button>
                        </div>
                        <div class="bulk-time-item">
                            <span class="bulk-time-label">終了</span>
                            <button id="bulkEndTimeBtn" class="time-display-btn">
                                <span id="bulkEndTimeDisplay">18:00</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 適用ボタン -->
                    <div class="bulk-apply-buttons">
                        <button id="applyAllBtn" class="btn btn-primary btn-full">開始、終了時間を全日に設定</button>
                        <button id="applyStartBtn" class="btn btn-apply btn-full">開始時間のみ全日に設定</button>
                        <button id="applyEndBtn" class="btn btn-apply btn-full">終了時間のみ全日に設定</button>
                    </div>
                    
                    <!-- 曜日別一括設定 -->
                    <div class="weekday-bulk-section">
                        <p class="weekday-bulk-label">設定した時間を曜日別に設定</p>
                        <div class="weekday-bulk-buttons-compact">
                            <button class="btn-weekday-compact btn-sun" data-day="0">日</button>
                            <button class="btn-weekday-compact" data-day="1">月</button>
                            <button class="btn-weekday-compact" data-day="2">火</button>
                            <button class="btn-weekday-compact" data-day="3">水</button>
                            <button class="btn-weekday-compact" data-day="4">木</button>
                            <button class="btn-weekday-compact" data-day="5">金</button>
                            <button class="btn-weekday-compact btn-sat" data-day="6">土</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 個別時間設定リスト -->
            <div class="time-list-section">
                <h2 class="section-title">個別設定</h2>
                <p class="hint-text">※各カードをタップして時間を設定できます</p>
                <p class="hint-text">※個別で設定した日は黄色で表示されます</p>
                <div class="time-list-compact" id="timeList">
                    <!-- Thymeleafでループ -->
                    <div class="time-card" th:each="dateInfo, stat : ${dateInfoList}" th:data-index="${stat.index}" th:classappend="${dateInfo.modified == 'true'} ? 'modified' : ''">
                        <input type="hidden" class="date-value" th:value="${dateInfo.date}">
                        <input type="hidden" class="dayofweek-value" th:value="${dateInfo.dayOfWeek}">
                        <input type="hidden" class="start-time-value" th:value="${dateInfo.startTime}">
                        <input type="hidden" class="end-time-value" th:value="${dateInfo.endTime}">

                        <div class="card-content-horizontal">
                            <div class="card-date" th:text="${dateInfo.displayDate}">11/15(金)</div>
                            <div class="card-time-section">
                                <span class="time-value start-display" th:text="${dateInfo.startTime}">09:00</span>
                                <span class="time-separator">～</span>
                                <span class="time-value end-display" th:text="${dateInfo.endTime}">18:00</span>
                            </div>
                        </div>
                        <div class="card-hours">
                            <span class="hours-icon">💼</span>
                            <span class="hours-text">9時間</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 休憩加味チェックボックス -->
            <div class="break-settings">
                <div class="break-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="breakCheckbox" class="checkbox-input">
                        <span class="checkbox-text">休憩を加味した時間を表示する</span>
                    </label>
                    
                    <button class="help-icon" id="helpBtn" title="休憩時間の計算ルール">
                        ❓
                    </button>
                </div>
            </div>
            
            <!-- 合計表示 -->
            <div class="summary-section">
                <div class="summary-item">
                    <span class="summary-label">出勤日</span>
                    <span class="summary-value" th:text="${totalDays} + '日'">0日</span>
                </div>
                <div class="summary-item" id="normalWorkHoursItem">
                    <span class="summary-label">勤務時間</span>
                    <span class="summary-value" id="totalHours">0時間</span>
                </div>
                <div class="summary-item" id="actualWorkHoursItem" style="display: none;">
                    <span class="summary-label">実労働時間</span>
                    <span class="summary-value" id="actualHours">0時間</span>
                </div>
                <div class="summary-item" id="totalBreakItem" style="display: none;">
                    <span class="summary-label">休憩</span>
                    <span class="summary-value" id="totalBreakTime">0分</span>
                </div>
            </div>
            
            <!-- ヘルプポップアップ -->
            <div id="helpOverlay" class="help-overlay" style="display: none;">
                <div id="helpPopup" class="help-popup">
                    <button class="help-close" id="helpClose">×</button>
                    <div class="help-content">
                        <p class="help-title">休憩時間のルール</p>
                        <div class="help-table">
                            <div class="help-row">
                                <div class="help-cell help-label">6時間未満</div>
                                <div class="help-cell help-value">0分</div>
                            </div>
                            <div class="help-row">
                                <div class="help-cell help-label">6～8時間未満</div>
                                <div class="help-cell help-value">45分</div>
                            </div>
                            <div class="help-row">
                                <div class="help-cell help-label">8時間以上</div>
                                <div class="help-cell help-value">60分</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- アクションボタン -->
            <div class="action-buttons">
                <button id="backBtn" class="btn btn-secondary" style="flex: 1;">
                    ← カレンダーに戻る
                </button>
                <button id="submitBtn" class="btn btn-next" style="flex: 1;">
                    確認して提出 →
                </button>
            </div>
            
            <form id="backForm" th:action="@{/}" method="get" style="display: none;">
                <!-- 日付情報 -->
                <th:block th:each="dateInfo : ${dateInfoList}">
                    <input type="hidden" name="dates" th:value="${dateInfo.date}">
                </th:block>
                <!-- 時間情報はJavaScriptで動的に追加 -->
            </form>
        </div>
    </div>
    
    <!-- 時間設定モーダル -->
    <div id="timePickerModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">勤務時間の設定</h3>
            
            <!-- 開始時間 -->
            <div class="modal-section">
                <div class="modal-section-header">
                    <label class="modal-label" style="margin-bottom: 0;">開始時間</label>
                    <!-- スライド式トグル -->
                    <div class="toggle-switch">
                        <input type="checkbox" id="startPeriodToggle" class="toggle-input">
                        <label for="startPeriodToggle" class="toggle-label">
                            <span class="toggle-text-am">午前</span>
                            <span class="toggle-text-pm">午後</span>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 時間選択 -->
                <div class="hour-selector-row">
                    <div class="hour-selector-inline" id="startHourSelector">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>
                
                <!-- 分選択 -->
                <div class="minute-selector-row">
                    <button class="minute-btn-inline" data-minute="00" data-target="start">00</button>
                    <button class="minute-btn-inline" data-minute="15" data-target="start">15</button>
                    <button class="minute-btn-inline" data-minute="30" data-target="start">30</button>
                    <button class="minute-btn-inline" data-minute="45" data-target="start">45</button>
                </div>
                
                <div class="time-preview">選択: <span id="startTimePreview">--:--</span></div>
            </div>
            
            <!-- 終了時間 -->
            <div class="modal-section">
                <div class="modal-section-header">
                    <label class="modal-label" style="margin-bottom: 0;">終了時間</label>
                    <!-- スライド式トグル -->
                    <div class="toggle-switch">
                        <input type="checkbox" id="endPeriodToggle" class="toggle-input" checked>
                        <label for="endPeriodToggle" class="toggle-label">
                            <span class="toggle-text-am">午前</span>
                            <span class="toggle-text-pm">午後</span>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 時間選択 -->
                <div class="hour-selector-row">
                    <div class="hour-selector-inline" id="endHourSelector">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>
                
                <!-- 分選択 -->
                <div class="minute-selector-row">
                    <button class="minute-btn-inline" data-minute="00" data-target="end">00</button>
                    <button class="minute-btn-inline" data-minute="15" data-target="end">15</button>
                    <button class="minute-btn-inline" data-minute="30" data-target="end">30</button>
                    <button class="minute-btn-inline" data-minute="45" data-target="end">45</button>
                </div>
                
                <div class="time-preview">選択: <span id="endTimePreview">--:--</span></div>
            </div>
            
            <div class="modal-work-hours">
                勤務時間: <span id="modalWorkHours">9時間</span>
            </div>
            
            <div class="modal-buttons">
                <button id="modalConfirm" class="btn btn-primary btn-full-width">設定する</button>
                <div class="modal-buttons-row">
                    <button id="modalCancel" class="btn btn-secondary">キャンセル</button>
                    <button id="removeShiftBtn" class="btn btn-danger" style="display:none;">シフトを外す</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3択ダイアログ -->
    <div id="threeChoiceDialog" class="dialog-overlay">
        <div class="dialog">
            <h3>一括設定の確認</h3>
            <p id="threeChoiceMessage" class="dialog-message"></p>
            <div class="three-choice-buttons">
                <button id="choiceModifiedOnly" class="btn btn-choice">個別設定した日以外を変更</button>
                <button id="choiceAll" class="btn btn-choice btn-primary">すべて変更</button>
                <button id="choiceCancel" class="btn btn-secondary">キャンセル</button>
            </div>
        </div>
    </div>
    
    <!-- 共通アラート/確認ダイアログ -->
    <div id="customDialog" class="help-overlay" style="display: none;">
        <div class="help-popup custom-dialog-popup">
            <button class="help-close" id="customDialogClose">×</button>
            <div class="help-content">
                <p class="help-title" id="customDialogMessage">確認</p>
                <div class="dialog-buttons" id="customDialogButtons" style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="customDialogCancel" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
                    <button id="customDialogOk" class="btn btn-primary" style="flex: 1;">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 確認ダイアログ -->
    <div id="confirmDialog" class="dialog-overlay">
        <div class="dialog dialog-large">
            <h3>シフト提出内容の最終確認</h3>
            <p class="confirm-message">以下の内容でシフトを提出してよろしいですか？</p>
            
            <div class="confirm-list" id="confirmList">
                <!-- JavaScriptで動的生成 -->
            </div>
            
            <div class="confirm-summary">
                <div class="summary-row">
                    <span>合計勤務日数:</span>
                    <span id="confirmTotalDays">0日</span>
                </div>
                <div class="summary-row">
                    <span>合計勤務時間:</span>
                    <span id="confirmTotalHours">0時間</span>
                </div>
            </div>
            
            <div class="dialog-buttons">
                <button id="cancelSubmit" class="btn btn-secondary">修正</button>
                <button id="finalSubmit" class="btn btn-primary btn-large">提出</button>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Thymeleafから日付データを取得
        const selectedDates = /*[[${dateInfoList}]]*/ [];
        /*]]>*/
    </script>
    <script th:src="@{/js/timeregister_js/timeregister.js}"></script>
</body>
</html>